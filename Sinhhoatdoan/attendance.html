<!DOCTYPE html><html lang="vi"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ƒêi·ªÉm danh Sinh ho·∫°t ƒêo√†n - ƒêo√†n ph∆∞·ªùng L√†o Cai</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"><link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"><style>:root{--primary:#0084ff;--success:#00c853;--warning:#ffab00;--danger:#ff3d00;--bg-light:#f8faff;--font-main:'Outfit',sans-serif}body{font-family:var(--font-main);background-color:var(--bg-light);color:#2d3436;min-height:100vh}.custom-nav{background:rgba(255,255,255,.8);backdrop-filter:blur(10px);border-bottom:1px solid rgba(0,0,0,.05);position:sticky;top:0;z-index:100}.page-header{padding:3rem 1.5rem 2rem;text-align:center;background:linear-gradient(to bottom,#fff,var(--bg-light))}.page-header h1{font-weight:800;font-size:1.8rem;color:#1a1a1a;margin-bottom:.5rem}.page-header .highlight-text{color:var(--primary);position:relative;display:inline-block}.section-title{padding:0 1rem;margin:2rem 0 1rem;font-weight:700;font-size:.85rem;color:#95a5a6;text-transform:uppercase;letter-spacing:1px;width:100%;grid-column:1/-1}.event-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;padding:0 1rem 3rem}@media screen and (max-width:768px){.event-grid{grid-template-columns:1fr}}.event-item{background:#fff;border-radius:20px;padding:1rem;position:relative;box-shadow:0 4px 12px rgba(0,0,0,.03);border:1px solid rgba(0,0,0,.05);transition:all .3s ease;display:flex;flex-direction:column;justify-content:space-between;min-height:180px}.event-item.is-open{border-top:5px solid var(--primary);background:#fff}.event-item.is-open:hover{transform:translateY(-5px);box-shadow:0 12px 24px rgba(0,132,255,.1)}.event-item.is-closed{background:#f8f9fa;border-top:5px solid #bdc3c7;opacity:.8}.event-item.is-closed .event-title{color:#7f8c8d}.event-status-pill{display:inline-flex;font-size:.7rem;font-weight:800;padding:4px 10px;border-radius:6px;margin-bottom:.8rem;width:fit-content}.pill-open{background:rgba(0,132,255,.1);color:var(--primary)}.pill-closed{background:rgba(0,0,0,.05);color:#7f8c8d}.event-title{font-size:1.1rem;font-weight:700;color:#2c3e50;margin-bottom:1rem;display:-webkit-box;line-clamp:2;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;line-height:1.4}.event-meta-list{display:flex;flex-wrap:wrap;gap:.8rem;margin-bottom:1rem}.meta-item{display:flex;align-items:center;gap:5px;font-size:.8rem;color:#7f8c8d;background:#f1f3f5;padding:4px 8px;border-radius:6px}.meta-item i{color:var(--primary)}.btn-checkin{background:var(--primary);color:#fff;border:none;border-radius:12px;padding:.8rem;width:100%;font-weight:700;font-size:.9rem;cursor:pointer;transition:.2s;text-align:center}.btn-checkin:hover{background:#0073e6}.closed-notice{font-size:.8rem;font-weight:600;color:#95a5a6;text-align:center;padding:5px}.modal{transition:opacity .25s ease}.modal-background{background-color:rgba(10,25,47,.5);backdrop-filter:blur(4px)}.modal-card{max-width:450px;width:90%;border-radius:24px;overflow:hidden}.modal-card-body{padding:2rem 1.5rem}.label{font-weight:600;font-size:.9rem;margin-bottom:.5rem}.input{border-radius:12px;border:2px solid #edf2f7;padding:1.2rem 1rem 1.2rem 2.5rem;height:auto;font-family:inherit;transition:all .2s}.input:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(0,132,255,.1)}.gps-stat-card{background:#f8f9fa;border-radius:16px;padding:1rem;display:flex;align-items:center;gap:1rem;margin:1.5rem 0;border:1px solid #e9ecef}.gps-icon{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0}.gps-text-title{font-size:.8rem;font-weight:700;text-transform:uppercase;color:#adb5bd;margin-bottom:2px}.gps-text-status{font-size:.95rem;font-weight:600}.stat-searching{color:var(--warning)}.icon-searching{background:rgba(255,171,0,.1);color:var(--warning)}.stat-ok{color:var(--success)}.icon-ok{background:rgba(0,200,83,.1);color:var(--success)}.stat-error{color:var(--danger)}.icon-error{background:rgba(255,61,0,.1);color:var(--danger)}@keyframes pulse-soft{0%{transform:scale(1);opacity:1}50%{transform:scale(1.05);opacity:.8}100%{transform:scale(1);opacity:1}}.pulse{animation:pulse-soft 2s infinite ease-in-out}@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}.animate-up{animation:slideUp .4s ease-out forwards}.preserve-newline{white-space:pre-wrap}</style></head><body><nav class="custom-nav shadow-sm"><div class="container is-max-desktop"><div class="is-flex is-justify-content-space-between is-align-items-center px-4 py-3"><a href="index.html" class="has-text-grey-dark"><i class="fas fa-arrow-left"></i> </a><span class="has-text-weight-bold">SINH HO·∫†T ƒêO√ÄN</span><div style="width:20px"></div></div></div></nav><div class="container is-max-desktop"><div class="page-header animate-up"><h1>ƒêi·ªÉm danh ƒëi·ªán t·ª≠</h1><p class="has-text-grey is-size-7 mt-1">Vui l√≤ng ch·ªçn bu·ªïi sinh ho·∫°t v√† b·∫≠t GPS ƒë·ªÉ th·ª±c hi·ªán.</p></div><div id="loadingScreen" class="py-6 has-text-centered"><div class="pulse"><span class="icon is-large has-text-primary"><i class="fas fa-circle-notch fa-spin fa-2x"></i></span></div><p class="mt-4 has-text-grey-light">ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu...</p></div><div id="emptyScreen" class="py-6 has-text-centered is-hidden px-4"><div class="mb-4"><span class="icon is-large has-text-grey-lighter" style="font-size:4rem"><i class="far fa-calendar-times"></i></span></div><h2 class="title is-5">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o</h2><p class="has-text-grey">Hi·ªán t·∫°i kh√¥ng c√≥ bu·ªïi sinh ho·∫°t n√†o di·ªÖn ra ho·∫∑c ƒë√£ k·∫øt th√∫c t·∫•t c·∫£.</p></div><div id="mainContent" class="is-hidden pb-6"><div id="eventList" class="event-grid"></div></div></div><div id="checkInModal" class="modal"><div class="modal-background" onclick="closeModal()"></div><div class="modal-card animate-up"><section class="modal-card-body"><div class="has-text-centered mb-5"><h3 id="modalName" class="title is-5 mb-1">...</h3><p id="modalTime" class="is-size-7 has-text-grey"></p></div><form id="attendanceForm"><div class="field"><label class="label">S·ªë ƒëi·ªán tho·∫°i ƒëƒÉng k√Ω</label><div class="control has-icons-left"><input class="input" type="tel" id="userPhone" placeholder="09xx xxx xxx" required> <span class="icon is-small is-left"><i class="fas fa-phone"></i></span></div></div><div class="gps-stat-card"><div id="gpsIcon" class="gps-icon icon-searching"><i class="fas fa-location-arrow"></i></div><div class="is-flex-grow-1"><div class="gps-text-title">T√¨nh tr·∫°ng v·ªã tr√≠</div><div id="gpsText" class="gps-text-status stat-searching">ƒêang ki·ªÉm tra...</div></div><button type="button" class="button is-ghost is-small" onclick="requestGPS()"><i class="fas fa-sync"></i></button></div><button type="submit" id="submitBtn" class="btn-attendance" disabled="disabled">X√ÅC NH·∫¨N ƒêI·ªÇM DANH</button> <button type="button" class="button is-fullwidth is-ghost is-small mt-3" onclick="closeModal()">H·ªßy b·ªè</button></form></section></div></div><script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script><script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script><script src="js/config.js"></script><script>let events=[],selectedEvent=null,userPos=null,gpsWatchId=null,loadingScreen=document.getElementById("loadingScreen"),emptyScreen=document.getElementById("emptyScreen"),mainContent=document.getElementById("mainContent"),eventList=document.getElementById("eventList"),checkInModal=document.getElementById("checkInModal");async function fetchEvents(){try{var e=(await db.ref("sinhhoatdoan/events").once("value")).val();e?((events=Object.entries(e).map(([e,t])=>({id:e,...t}))).sort((e,t)=>t.startTime-e.startTime),renderList()):(loadingScreen.classList.add("is-hidden"),emptyScreen.classList.remove("is-hidden"))}catch(e){console.error(e),alert("L·ªói t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.")}}function renderList(){eventList.innerHTML="";let a=Date.now();var e,t=events.filter(e=>e.isOpen&&(!e.endTime||a<e.endTime)&&e.startTime&&a>=e.startTime),i=events.filter(e=>e.isOpen&&e.startTime&&a<e.startTime),s=events.filter(e=>!e.isOpen||e.endTime&&a>=e.endTime);0<t.length&&((e=document.createElement("div")).className="section-title animate-up",e.innerHTML="üî• ƒêang di·ªÖn ra",eventList.appendChild(e),t.forEach(e=>{var t=new Date(e.startTime).toLocaleDateString("vi-VN"),i=document.createElement("div");i.className="event-item is-open animate-up",i.onclick=()=>openModal(e.id),i.innerHTML=`
                        <div class="event-content">
                            <div class="event-status-pill pill-open">
                                <i class="fas fa-bolt"></i> ƒêang m·ªü ƒëi·ªÉm danh
                            </div>
                            <div class="event-title">${e.name}</div>
                            <div class="event-meta-list">
                                <div class="meta-item" style="flex-direction: column; align-items: flex-start;">
                                    <div><i class="fas fa-info-circle"></i> <b class="mr-1">L∆∞u √Ω:</b></div>
                                    <div class="mt-1" style="width: 100%;">
                                        <div class="desc-content preserve-newline" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; font-size: 0.8rem;">${e.description||"Kh√¥ng c√≥ m√¥ t·∫£"}</div>
                                        ${e.description&&60<e.description.length?`
                                            <a href="javascript:void(0)" class="has-text-link is-size-7 mt-1" onclick="event.stopPropagation(); const s = this.previousElementSibling.style; if(s.display === '-webkit-box') { s.display = 'block'; this.innerText = 'Thu g·ªçn'; } else { s.display = '-webkit-box'; this.innerText = 'Xem th√™m'; }">Xem th√™m</a>
                                        `:""}
                                    </div>
                                </div>
                                <div class="meta-item"><i class="far fa-calendar-check"></i> <b>Ng√†y:</b> ${t}</div>
                                ${e.endTime?`
                                    <div class="meta-item has-text-danger"><i class="fas fa-clock"></i> <b>K·∫øt th√∫c:</b> ${new Date(e.endTime).toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"})} ng√†y ${new Date(e.endTime).toLocaleDateString("vi-VN")}</div>
                                `:""}
                                <div class="meta-item"><i class="fas fa-location-arrow"></i> <b>B√°n k√≠nh:</b> ${e.radius}m</div>
                                <div class="meta-item">
                                    <a href="https://www.google.com/maps?q=${e.location.lat},${e.location.lng}" target="_blank" class="has-text-link is-size-7">
                                        <i class="fas fa-map-marked-alt"></i> Xem b·∫£n ƒë·ªì
                                    </a>
                                </div>
                            </div>
                            <button class="btn-checkin">
                                <span>B·∫Øt ƒë·∫ßu ƒêi·ªÉm danh</span>
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    `,eventList.appendChild(i)})),0<i.length&&((e=document.createElement("div")).className="section-title animate-up mt-5",e.innerHTML="üìÖ S·∫Øp di·ªÖn ra",eventList.appendChild(e),i.forEach(e=>{var t=new Date(e.startTime).toLocaleDateString("vi-VN"),i=new Date(e.startTime).toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"}),a=document.createElement("div");a.className="event-item is-closed animate-up",a.style.opacity="0.9",a.innerHTML=`
                        <div class="event-content">
                            <div class="event-status-pill pill-closed" style="background: rgba(255, 171, 0, 0.1); color: #ffab00;">
                                <i class="fas fa-clock"></i> Ch·ªù b·∫Øt ƒë·∫ßu
                            </div>
                            <div class="event-title">${e.name}</div>
                            <div class="event-meta-list">
                                <div class="meta-item"><i class="fas fa-play"></i> <b>B·∫Øt ƒë·∫ßu l√∫c:</b> ${i} - ${t}</div>
                                <div class="meta-item" style="flex-direction: column; align-items: flex-start;">
                                    <div><i class="fas fa-info-circle"></i> <b class="mr-1">L∆∞u √Ω:</b></div>
                                    <div class="mt-1" style="width: 100%;">
                                        <div class="desc-content preserve-newline" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; font-size: 0.8rem;">${e.description||"Kh√¥ng c√≥ m√¥ t·∫£"}</div>
                                        ${e.description&&60<e.description.length?`
                                            <a href="javascript:void(0)" class="has-text-link is-size-7 mt-1" onclick="event.stopPropagation(); const s = this.previousElementSibling.style; if(s.display === '-webkit-box') { s.display = 'block'; this.innerText = 'Thu g·ªçn'; } else { s.display = '-webkit-box'; this.innerText = 'Xem th√™m'; }">Xem th√™m</a>
                                        `:""}
                                    </div>
                                </div>
                            </div>
                            <div class="closed-notice">N√∫t ƒëi·ªÉm danh s·∫Ω t·ª± ƒë·ªông xu·∫•t hi·ªán khi ƒë·∫øn gi·ªù sinh ho·∫°t</div>
                        </div>
                    `,eventList.appendChild(a)})),0<s.length&&((t=document.createElement("div")).className="section-title animate-up mt-5",t.innerHTML="üïí ƒê√£ k·∫øt th√∫c",eventList.appendChild(t),s.forEach(e=>{var t=new Date(e.startTime).toLocaleDateString("vi-VN"),i=document.createElement("div");i.className="event-item is-closed animate-up",i.innerHTML=`
                        <div class="event-content">
                            <div class="event-status-pill pill-closed">
                                <i class="fas fa-lock"></i> ƒê√£ ƒë√≥ng
                            </div>
                            <div class="event-title">${e.name}</div>
                            <div class="event-meta-list">
                                <div class="meta-item" style="flex-direction: column; align-items: flex-start;">
                                    <div><i class="fas fa-info-circle"></i> <b class="mr-1">M√¥ t·∫£:</b></div>
                                    <div class="mt-1" style="width: 100%;">
                                        <div class="desc-content preserve-newline" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; font-size: 0.8rem;">${e.description||"..."}</div>
                                        ${e.description&&60<e.description.length?`
                                            <a href="javascript:void(0)" class="has-text-link is-size-7 mt-1" onclick="event.stopPropagation(); const s = this.previousElementSibling.style; if(s.display === '-webkit-box') { s.display = 'block'; this.innerText = 'Thu g·ªçn'; } else { s.display = '-webkit-box'; this.innerText = 'Xem th√™m'; }">Xem th√™m</a>
                                        `:""}
                                    </div>
                                </div>
                                <div class="meta-item"><i class="far fa-calendar"></i> ${t}</div>
                            </div>
                            <div class="closed-notice">
                                ${e.endTime&&a>=e.endTime?"H·ªá th·ªëng ƒë√£ t·ª± ƒë·ªông ƒë√≥ng l√∫c "+new Date(e.endTime).toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"}):"Bu·ªïi sinh ho·∫°t n√†y ƒë√£ d·ª´ng ti·∫øp nh·∫≠n ƒëi·ªÉm danh"}
                            </div>
                        </div>
                    `,eventList.appendChild(i)})),loadingScreen.classList.add("is-hidden"),mainContent.classList.remove("is-hidden")}function getDistance(e,t,i,a){var s=e=>e*Math.PI/180,n=s(e),l=s(i),i=s(i-e),e=s(a-t),s=Math.sin(i/2)**2+Math.cos(n)*Math.cos(l)*Math.sin(e/2)**2;return 12742e3*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))}function updateGPSUI(e,t=0,i=0){var a=document.getElementById("gpsIcon"),s=document.getElementById("gpsText"),n=document.getElementById("submitBtn");a.className="gps-icon",s.className="gps-text-status","searching"===e?(a.classList.add("icon-searching"),s.classList.add("stat-searching"),s.innerHTML="ƒêang d√≤ v·ªã tr√≠...",n.disabled=!0):"ok"===e?(a.className="gps-icon icon-ok",s.className="gps-text-status stat-ok",s.innerHTML=`H·ª£p l·ªá (C√°ch ${Math.round(t)}m) <br><small class="has-text-grey">Sai s·ªë: ${Math.round(i)}m</small>`,n.disabled=!1):("far"===e?(a.className="gps-icon icon-error",s.className="gps-text-status stat-error",s.innerHTML=`Qu√° xa (${Math.round(t)}m > ${selectedEvent.radius}m) <br><small class="has-text-grey">Sai s·ªë: ${Math.round(i)}m</small>`):"denied"===e?(a.className="gps-icon icon-error",s.className="gps-text-status stat-error",s.innerHTML="Quy·ªÅn v·ªã tr√≠ b·ªã t·ª´ ch·ªëi! H√£y b·∫≠t l·∫°i trong c√†i ƒë·∫∑t tr√¨nh duy·ªát."):(a.className="gps-icon icon-error",s.className="gps-text-status stat-error",s.innerHTML="L·ªói ƒë·ªãnh v·ªã. H√£y b·∫≠t GPS v√† 4G!"),n.disabled=!0)}function requestGPS(){if(!navigator.geolocation)return updateGPSUI("error");updateGPSUI("searching"),gpsWatchId&&navigator.geolocation.clearWatch(gpsWatchId);var e={enableHighAccuracy:!0,timeout:15e3,maximumAge:0};navigator.geolocation.getCurrentPosition(e=>{handleGPSUpdate(e)},e=>console.warn("Initial GPS failed:",e),e),gpsWatchId=navigator.geolocation.watchPosition(e=>{handleGPSUpdate(e)},e=>{console.warn(e),1===e.code?updateGPSUI("denied"):userPos||updateGPSUI("error")},e)}function handleGPSUpdate(e){userPos={lat:e.coords.latitude,lng:e.coords.longitude};var t,e=e.coords.accuracy;selectedEvent&&selectedEvent.location&&((t=getDistance(userPos.lat,userPos.lng,selectedEvent.location.lat,selectedEvent.location.lng))<=selectedEvent.radius?updateGPSUI("ok",t,e):updateGPSUI("far",t,e))}function openModal(t){var e=`https://www.google.com/maps?q=${(selectedEvent=events.find(e=>e.id===t)).location.lat},`+selectedEvent.location.lng;document.getElementById("modalName").textContent=selectedEvent.name,document.getElementById("modalTime").innerHTML=`
                <div class="tags is-centered mb-2">
                    <span class="tag is-info is-light">
                        <i class="fas fa-play mr-1"></i> B·∫Øt ƒë·∫ßu: ${new Date(selectedEvent.startTime).toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"})}
                    </span>
                    ${selectedEvent.endTime?`
                    <span class="tag is-danger is-light">
                        <i class="fas fa-stop mr-1"></i> K·∫øt th√∫c: ${new Date(selectedEvent.endTime).toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"})}
                    </span>
                    `:""}
                </div>
                <div class="mb-3">
                    <a href="${e}" target="_blank" class="button is-small is-link is-light is-rounded">
                        <i class="fas fa-directions mr-1"></i> Xem tr√™n b·∫£n ƒë·ªì
                    </a>
                </div>
                <p class="has-text-grey-darker preserve-newline is-size-7"><i>${selectedEvent.description||""}</i></p>
            `,checkInModal.classList.add("is-active"),requestGPS()}function closeModal(){checkInModal.classList.remove("is-active"),gpsWatchId&&(navigator.geolocation.clearWatch(gpsWatchId),gpsWatchId=null)}document.getElementById("attendanceForm").onsubmit=async t=>{t.preventDefault();var i=document.getElementById("userPhone").value.trim(),e=document.getElementById("submitBtn");e.classList.add("is-loading");try{var a=await db.ref("sinhhoatdoan/members").orderByChild("phone").equalTo(i).once("value");if(!a.exists())throw new Error("Th√†nh vi√™n ch∆∞a ƒëƒÉng k√Ω SƒêT n√†y!");var s=Object.keys(a.val())[0],n=a.val()[s];let e="unknown";try{var l=await(await fetch("https://api.ipify.org?format=json")).json();e=l.ip.replace(/\./g,"_")}catch(t){}var c=db.ref(`sinhhoatdoan/event_ips/${selectedEvent.id}/`+e),d=await c.once("value");if(d.exists()&&d.val().uid!==s)throw new Error("M·ªói thi·∫øt b·ªã ch·ªâ ƒë∆∞·ª£c ƒëi·ªÉm danh 1 l·∫ßn cho 1 ng∆∞·ªùi!");var o=db.ref(`sinhhoatdoan/attendance/${selectedEvent.id}/`+s);if((await o.once("value")).exists())throw new Error("B·∫°n ƒë√£ ƒëi·ªÉm danh bu·ªïi n√†y r·ªìi!");await o.set({timestamp:firebase.database.ServerValue.TIMESTAMP,memberName:n.fullName,location:userPos,ip:e,status:"present"}),await c.set({uid:s,name:n.fullName}),await db.ref("sinhhoatdoan/members/"+s).update({stars:(n.stars||0)+1}),alert("üéâ ƒêi·ªÉm danh th√†nh c√¥ng! B·∫°n nh·∫≠n ƒë∆∞·ª£c th√™m 1 sao v√†ng."),closeModal(),location.reload()}catch(e){alert("‚ùå L·ªói: "+e.message)}finally{e.classList.remove("is-loading")}},fetchEvents()</script></body></html>