<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n tr·ªã - Sinh ho·∫°t ƒëo√†n</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .sidebar { background: #fff; height: 100vh; border-right: 1px solid #eee; padding-top: 1rem; }
        .sidebar-item { padding: 1rem; cursor: pointer; border-left: 3px solid transparent; }
        .sidebar-item:hover { background: #f9f9f9; }
        .sidebar-item.is-active { border-left-color: var(--primary-color); background: #f0fdfa; font-weight: bold; color: var(--primary-color); }
        .star-box { background: #fff3cd; color: #856404; padding: 2px 8px; border-radius: 12px; font-weight: bold; display: inline-flex; align-items: center; gap: 4px; }
    </style>
</head>
<body>

    <!-- LOGIN SECTION -->
    <div id="loginSection" class="hero is-fullheight">
        <div class="hero-body">
            <div class="container" style="max-width: 400px;">
                <div class="card p-5 animate-fade-in">
                    <div class="has-text-centered mb-4">
                        <span class="icon is-large has-text-primary"><i class="fas fa-shield-alt fa-3x"></i></span>
                        <h1 class="title is-4 mt-3">ƒêƒÉng nh·∫≠p Qu·∫£n tr·ªã</h1>
                    </div>
                    <form id="loginForm">
                        <div class="field">
                            <label class="label">M·∫≠t kh·∫©u</label>
                            <div class="control has-icons-left">
                                <input class="input" type="password" id="adminPass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u qu·∫£n tr·ªã" required>
                                <span class="icon is-small is-left"><i class="fas fa-lock"></i></span>
                            </div>
                        </div>
                        <button type="submit" class="button is-primary is-fullwidth mt-4">Truy c·∫≠p</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD SECTION -->
    <div id="dashboardSection" class="is-hidden">
        <div class="columns is-gapless mb-0">
            <!-- Sidebar -->
            <div class="column is-2 sidebar is-hidden-touch">
                <div class="has-text-centered mb-5 px-2">
                    <h2 class="title is-5 has-text-primary">Admin Panel</h2>
                    <p class="is-size-7">ƒêo√†n ph∆∞·ªùng L√†o Cai</p>
                </div>
                <div class="sidebar-item is-active" onclick="switchTab('members')">
                    <i class="fas fa-users mr-2"></i> Th√†nh vi√™n
                </div>
                <div class="sidebar-item" onclick="switchTab('events')">
                    <i class="fas fa-calendar-check mr-2"></i> Bu·ªïi Sinh ho·∫°t
                </div>
                <div class="sidebar-item has-text-danger mt-5" onclick="doLogout()">
                    <i class="fas fa-sign-out-alt mr-2"></i> ƒêƒÉng xu·∫•t
                </div>
            </div>

            <!-- Content -->
            <div class="column is-10 has-background-light" style="min-height: 100vh;">
                <nav class="navbar is-white shadow-sm mb-4 px-4">
                    <div class="navbar-brand">
                        <div class="navbar-item is-hidden-desktop" onclick="document.querySelector('.sidebar').classList.toggle('is-hidden-touch')">
                            <i class="fas fa-bars"></i>
                        </div>
                        <div class="navbar-item has-text-weight-bold" id="pageTitle">Qu·∫£n l√Ω Th√†nh vi√™n</div>
                    </div>
                </nav>

                <div class="p-4 container is-fluid">
                    
                    <!-- TAB: MEMBERS -->
                    <div id="tabMembers">
                        <div class="level">
                            <div class="level-left">
                                <div class="field has-addons">
                                    <p class="control">
                                        <input class="input" type="text" id="paramSearch" placeholder="T√¨m theo t√™n/SƒêT...">
                                    </p>
                                    <p class="control">
                                        <button class="button is-info">T√¨m</button>
                                    </p>
                                </div>
                            </div>
                            <div class="level-right">
                                <button class="button is-success is-light" onclick="exportExcel()">
                                    <i class="fas fa-file-excel mr-2"></i> Xu·∫•t Excel
                                </button>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-content p-0">
                                <div class="table-container">
                                    <table class="table is-fullwidth is-striped is-hoverable">
                                        <thead>
                                            <tr>
                                                <th>H·ªç v√† t√™n</th>
                                                <th>NƒÉm sinh</th>
                                                <th>Tr∆∞·ªùng/L·ªõp</th>
                                                <th>SƒêT</th>
                                                <th>Sao v√†ng</th>
                                                <th>Tr·∫°ng th√°i</th>
                                                <th>Thao t√°c</th>
                                            </tr>
                                        </thead>
                                        <tbody id="memberList">
                                            <!-- JS render -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: EVENTS -->
                    <div id="tabEvents" class="is-hidden">
                        <div class="level">
                            <div class="level-left">
                                <h2 class="subtitle">Danh s√°ch s·ª± ki·ªán</h2>
                            </div>
                            <div class="level-right">
                                <button class="button is-primary" onclick="openCreateEventModal()">
                                    <i class="fas fa-plus mr-2"></i> T·∫°o bu·ªïi m·ªõi
                                </button>
                            </div>
                        </div>

                        <div id="eventList" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
                            <!-- JS Render Cards -->
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: CREATE EVENT -->
    <div id="eventModal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title" id="modalTitle">T·∫°o bu·ªïi sinh ho·∫°t m·ªõi</p>
                <button class="delete" aria-label="close" onclick="closeModal('eventModal')"></button>
            </header>
            <section class="modal-card-body">
                <form id="createEventForm">
                    <div class="field">
                        <label class="label">T√™n bu·ªïi sinh ho·∫°t</label>
                        <div class="control">
                            <input class="input" type="text" id="evtName" placeholder="VD: Sinh ho·∫°t h√® T7/2026" required>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label">M√¥ t·∫£ bu·ªïi sinh ho·∫°t</label>
                        <div class="control">
                            <textarea class="textarea" id="evtDesc" placeholder="Nh·∫≠p n·ªôi dung, ƒë·ªãa ch·ªâ ho·∫∑c l∆∞u √Ω cho bu·ªïi sinh ho·∫°t..." rows="2"></textarea>
                        </div>
                    </div>
                    <div class="columns">
                        <div class="column is-4">
                            <div class="field">
                                <label class="label">B√°n k√≠nh (m)</label>
                                <div class="control">
                                    <input class="input" type="number" id="evtRadius" value="100">
                                </div>
                            </div>
                        </div>
                        <div class="column is-4">
                            <div class="field">
                                <label class="label">Vƒ© ƒë·ªô (Lat)</label>
                                <div class="control">
                                    <input class="input" type="number" step="any" id="evtLat" placeholder="VD: 21.123">
                                </div>
                            </div>
                        </div>
                        <div class="column is-4">
                            <div class="field">
                                <label class="label">Kinh ƒë·ªô (Lng)</label>
                                <div class="control">
                                    <input class="input" type="number" step="any" id="evtLng" placeholder="VD: 105.123">
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="field">
                            <button type="button" class="button is-info is-small is-outlined" onclick="getAdminGPS()">
                                <i class="fas fa-map-marker-alt mr-1"></i> L·∫•y t·ªça ƒë·ªô hi·ªán t·∫°i (GPS)
                            </button>
                            <p class="help is-success is-hidden" id="gpsMsg">
                                <span class="icon"><i class="fas fa-check"></i></span>
                                ƒê√£ l·∫•y t·ªça ƒë·ªô! (Sai s·ªë: <span id="accVal"></span>m)
                            </p>
                            <p class="help">
                                <a id="mapLink" href="#" target="_blank" class="is-hidden">
                                    <i class="fas fa-map-marked-alt"></i> Xem v·ªã tr√≠ tr√™n Google Maps
                                </a>
                            </p>
                            <article class="message is-warning is-small mt-2" id="gpsWarning">
                                <div class="message-body">
                                    <strong>L∆∞u √Ω:</strong> GPS tr√™n m√°y t√≠nh th∆∞·ªùng b·ªã l·ªách 50-200m do d√πng ƒë·ªãnh v·ªã m·∫°ng. 
                                    <br>N√™n d√πng <strong>ƒêi·ªán tho·∫°i</strong> ƒë·ªÉ l·∫•y t·ªça ƒë·ªô ch√≠nh x√°c nh·∫•t!
                                </div>
                            </article>
                        </div>
                </form>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" onclick="saveEvent()">L∆∞u th√¥ng tin</button>
                <button class="button" onclick="closeModal('eventModal')">H·ªßy</button>
            </footer>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="js/config.js"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <script>
        const ADMIN_PASS = "tranhuyhoang";
        let CURRENT_GPS = null;

        // AUTH LOGIC
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const pass = document.getElementById('adminPass').value;
            if (pass === ADMIN_PASS) {
                sessionStorage.setItem('shd_admin', 'true');
                showDashboard();
            } else {
                alert('M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!');
            }
        });

        function checkAuth() {
            if (sessionStorage.getItem('shd_admin') === 'true') {
                showDashboard();
            }
        }
        
        function showDashboard() {
            document.getElementById('loginSection').classList.add('is-hidden');
            document.getElementById('dashboardSection').classList.remove('is-hidden');
            loadMembers();
            loadEvents();
        }

        function doLogout() {
            sessionStorage.removeItem('shd_admin');
            location.reload();
        }

        // TABS LOGIC
        function switchTab(tabName) {
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('is-active'));
            event.currentTarget.classList.add('is-active');
            
            if (tabName === 'members') {
                document.getElementById('tabMembers').classList.remove('is-hidden');
                document.getElementById('tabEvents').classList.add('is-hidden');
                document.getElementById('pageTitle').textContent = 'Qu·∫£n l√Ω Th√†nh vi√™n';
            } else {
                document.getElementById('tabMembers').classList.add('is-hidden');
                document.getElementById('tabEvents').classList.remove('is-hidden');
                document.getElementById('pageTitle').textContent = 'Qu·∫£n l√Ω Bu·ªïi sinh ho·∫°t';
            }
        }

        // --- MEMBER LOGIC ---
        let adminMembers = []; // Store for search

        function loadMembers() {
            db.ref('sinhhoatdoan/members').on('value', snap => {
                const data = snap.val();
                if (!data) {
                    adminMembers = [];
                } else {
                    adminMembers = Object.entries(data).map(([key, val]) => ({...val, key}));
                    // Sort by stars descending
                    adminMembers.sort((a, b) => (b.stars || 0) - (a.stars || 0));
                }
                renderAdminMembers(adminMembers);
            });
        }

        function renderAdminMembers(list) {
            const container = document.getElementById('memberList');
            container.innerHTML = '';
            
            if (list.length === 0) {
                container.innerHTML = '<tr><td colspan="8" class="has-text-centered">Ch∆∞a c√≥ th√†nh vi√™n n√†o</td></tr>';
                return;
            }

            list.forEach(mem => {
                // SchoolClass
                let sc = "";
                if (mem.school) sc += mem.school;
                if (mem.className) sc += (sc ? ` - ${mem.className}` : mem.className);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${mem.fullName}</strong></td>
                    <td>${mem.birthYear}</td>
                    <td>${sc}</td>
                    <td>${mem.phone}</td>
                    <td><div class="star-box"><i class="fas fa-star"></i> ${mem.stars || 0}</div></td>
                    <td><span class="tag ${mem.status === 'active' ? 'is-success' : 'is-dark'} is-light">${mem.status}</span></td>
                    <td>
                        <div class="buttons are-small">
                            <button class="button is-danger is-light" onclick="deleteMember('${mem.key}')">X√≥a</button>
                            <button class="button is-warning is-light" onclick="adjustStar('${mem.key}', ${mem.stars || 0})">+ Sao</button>
                        </div>
                    </td>
                `;
                container.appendChild(row);
            });
        }

        // Search Admin - Realtime
        document.getElementById('paramSearch').addEventListener('input', (e) => {
             const term = e.target.value.toLowerCase().trim();
             if (!term) {
                 renderAdminMembers(adminMembers);
                 return;
             }
             const filtered = adminMembers.filter(m => 
                (m.fullName && m.fullName.toLowerCase().includes(term)) ||
                (m.phone && m.phone.includes(term))
             );
             renderAdminMembers(filtered);
        });


        function deleteMember(key) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th√†nh vi√™n n√†y?')) {
                db.ref(`sinhhoatdoan/members/${key}`).remove();
            }
        }

        function adjustStar(key, currentStars) {
            const newStars = prompt("Nh·∫≠p s·ªë sao m·ªõi:", currentStars + 1);
            if (newStars !== null) {
                db.ref(`sinhhoatdoan/members/${key}`).update({ stars: parseInt(newStars) });
            }
        }

        // --- EVENT LOGIC ---
        let editingEventKey = null;

        function loadEvents() {
            db.ref('sinhhoatdoan/events').on('value', snap => {
                const list = document.getElementById('eventList');
                list.innerHTML = '';
                const data = snap.val();

                if (!data) return;

                // Sort by time descending (newest first)
                const sortedEvents = Object.entries(data).sort((a,b) => b[1].startTime - a[1].startTime);

                sortedEvents.forEach(([key, evt]) => {
                    const card = document.createElement('div');
                    card.className = 'animate-fade-in';
                    // Show current status correctly
                    const statusClass = evt.isOpen ? 'is-success' : 'is-danger';
                    const statusText = evt.isOpen ? 'ƒêang m·ªü' : 'ƒê√£ ƒë√≥ng';
                    
                    card.innerHTML = `
                        <div class="card h-100">
                            <header class="card-header has-background-light">
                                <p class="card-header-title">${evt.name}</p>
                            </header>
                            <div class="card-content">
                                <div class="tags are-medium">
                                    <span class="tag ${statusClass}">${statusText}</span>
                                    <span class="tag is-info is-light">${new Date(evt.startTime).toLocaleDateString('vi-VN')}</span>
                                </div>
                                <div class="content is-size-7 mt-3">
                                    <div class="mb-2">
                                        <strong>M√¥ t·∫£:</strong> 
                                        <div class="description-wrapper mt-1">
                                            <span class="desc-content preserve-newline" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5;">${evt.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</span>
                                            ${evt.description && evt.description.length > 80 ? `
                                                <a href="javascript:void(0)" class="has-text-link" onclick="const s = this.previousElementSibling.style; if(s.display === '-webkit-box') { s.display = 'block'; this.innerText = 'Thu g·ªçn'; } else { s.display = '-webkit-box'; this.innerText = 'Xem th√™m'; }">Xem th√™m</a>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <p><i class="fas fa-map-marker-alt"></i> BK: ${evt.radius}m</p>
                                    <p>
                                        <a href="https://www.google.com/maps?q=${evt.location?.lat},${evt.location?.lng}" target="_blank" class="has-text-link">
                                            <i class="fas fa-directions"></i> Xem v·ªã tr√≠ tr√™n Google Maps
                                        </a>
                                    </p>
                                </div>
                            </div>
                            <footer class="card-footer">
                                <a href="#" class="card-footer-item has-text-primary" onclick="toggleEvent('${key}', ${!evt.isOpen})">
                                    ${evt.isOpen ? 'üîí ƒê√≥ng' : 'üîì M·ªü'}
                                </a>
                                <a href="#" class="card-footer-item has-text-info" onclick='openEditEventModal("${key}", ${JSON.stringify(evt)})'>
                                    ‚úèÔ∏è S·ª≠a
                                </a>
                                <a href="#" class="card-footer-item has-text-danger" onclick="deleteEvent('${key}')">X√≥a</a>
                            </footer>
                        </div>
                    `;
                    list.appendChild(card);
                });
            });
        }

        function openCreateEventModal() {
            editingEventKey = null;
            document.getElementById('modalTitle').textContent = "T·∫°o bu·ªïi sinh ho·∫°t m·ªõi";
            document.getElementById('createEventForm').reset();
            document.getElementById('eventModal').classList.add('is-active');
            document.getElementById('gpsMsg').classList.add('is-hidden');
            CURRENT_GPS = null;
        }

        function openEditEventModal(key, evt) {
            editingEventKey = key;
             document.getElementById('modalTitle').textContent = "C·∫≠p nh·∫≠t bu·ªïi sinh ho·∫°t";
            document.getElementById('evtName').value = evt.name;
            document.getElementById('evtDesc').value = evt.description || "";
            document.getElementById('evtRadius').value = evt.radius;
            // Fill Coordinates
            if (evt.location) {
                CURRENT_GPS = evt.location;
                document.getElementById('evtLat').value = evt.location.lat;
                document.getElementById('evtLng').value = evt.location.lng;
                
                // Show Map Link for stored location
                const mapUrl = `https://www.google.com/maps?q=${evt.location.lat},${evt.location.lng}`;
                const link = document.getElementById('mapLink');
                link.href = mapUrl;
                link.innerHTML = `<i class="fas fa-map-marked-alt"></i> Xem v·ªã tr√≠ n√†y tr√™n Google Maps`;
                link.classList.remove('is-hidden');
            }
            document.getElementById('eventModal').classList.add('is-active');
        }        

        function closeModal(id) {
            document.getElementById(id).classList.remove('is-active');
        }

        function getAdminGPS() {
            if (!navigator.geolocation) return alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS');
            
            const btn = event.currentTarget;
            btn.classList.add('is-loading');
            
            navigator.geolocation.getCurrentPosition(pos => {
                CURRENT_GPS = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                const acc = Math.round(pos.coords.accuracy);
                
                document.getElementById('evtLat').value = CURRENT_GPS.lat;
                document.getElementById('evtLng').value = CURRENT_GPS.lng;
                
                // Show Msg & Accuracy
                document.getElementById('gpsMsg').classList.remove('is-hidden');
                document.getElementById('accVal').textContent = acc;
                btn.classList.remove('is-loading');

                // Color code accuracy
                const msgEl = document.getElementById('gpsMsg');
                if (acc < 50) {
                    msgEl.className = "help is-success";
                } else if (acc < 200) {
                    msgEl.className = "help is-warning";
                } else {
                    msgEl.className = "help is-danger";
                }

                // Show Map Link
                const mapUrl = `https://www.google.com/maps?q=${CURRENT_GPS.lat},${CURRENT_GPS.lng}`;
                const link = document.getElementById('mapLink');
                link.href = mapUrl;
                link.classList.remove('is-hidden');

            }, err => {
                btn.classList.remove('is-loading');
                alert("L·ªói l·∫•y GPS: " + err.message + "\n\nL∆∞u √Ω: B·∫°n ph·∫£i cho ph√©p quy·ªÅn v·ªã tr√≠ tr√™n tr√¨nh duy·ªát v√† n√™n d√πng ƒëi·ªán tho·∫°i.");
            }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
        }

        function saveEvent() {
            const name = document.getElementById('evtName').value;
            const description = document.getElementById('evtDesc').value;
            const radius = document.getElementById('evtRadius').value;
            // Read from hidden/visible inputs in case user edited them manually (if we added visible inputs)
            // But here we rely on hidden inputs updated by getAdminGPS or set by logic.
            // Requirement: "cho ph√©p admin ch·ªânh s·ª≠a v·ªã tr√≠ n·ªØa nh√©, xem t·ªça ƒë·ªô chi ti·∫øt".
            // So we really should have visible inputs for manual edit if needed.
            
            const latInput = parseFloat(document.getElementById('evtLat').value);
            const lngInput = parseFloat(document.getElementById('evtLng').value);

            if (!name) return alert("Vui l√≤ng nh·∫≠p t√™n");
            if (!latInput || !lngInput) return alert("Vui l√≤ng l·∫•y t·ªça ƒë·ªô ho·∫∑c nh·∫≠p t·ªça ƒë·ªô!");

            const eventData = {
                name,
                description,
                radius: parseInt(radius),
                location: { lat: latInput, lng: lngInput }
            };

            if (editingEventKey) {
                // Update
                db.ref(`sinhhoatdoan/events/${editingEventKey}`).update(eventData);
            } else {
                // Create
                db.ref('sinhhoatdoan/events').push({
                    ...eventData,
                    isOpen: true,
                    startTime: firebase.database.ServerValue.TIMESTAMP
                });
            }

            closeModal('eventModal');
        }

        function toggleEvent(key, newState) {
            db.ref(`sinhhoatdoan/events/${key}`).update({ isOpen: newState });
        }
        
        function deleteEvent(key) {
            if (confirm("X√≥a s·ª± ki·ªán n√†y?")) {
                db.ref(`sinhhoatdoan/events/${key}`).remove();
            }
        }

        // --- EXPORT EXCEL ---
        function exportExcel() {
            // Simple Export implementation
            const table = document.querySelector('table');
            const wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, 'DanhSach_SinhHoatDoan.xlsx');
        }

        // Init
        checkAuth();
    </script>
</body>
</html>
