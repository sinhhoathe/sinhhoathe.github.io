<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phiếu đăng ký tham gia sinh hoạt Đoàn</title>
    <!-- Bulma CSS CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar is-white shadow-sm">
        <div class="container">
            <div class="navbar-brand">
                <a class="navbar-item has-text-primary" href="index.html">
                    <span class="icon mr-2"><i class="fas fa-chevron-left"></i></span>
                    Quay lại
                </a>
                <div class="navbar-item has-text-weight-bold ml-auto">
                    ĐĂNG KÝ THÀNH VIÊN
                </div>
            </div>
        </div>
    </nav>

    <section class="section">
        <div class="container" style="max-width: 600px;">
            <div class="card p-4 animate-fade-in">
                <div class="card-content">
                    <div class="has-text-centered mb-5">
                        <span class="icon is-large has-text-primary">
                            <i class="fas fa-user-plus fa-3x"></i>
                        </span>
                        <h2 class="title is-4 mt-3">Phiếu đăng ký tham gia sinh hoạt Đoàn</h2>
                        
                        <article class="message is-warning is-small mt-4">
                            <div class="message-body">
                                <strong>⚠️ Lưu ý quan trọng:</strong>
                                <ul style="list-style-type: disc; margin-left: 20px;" class="mt-2">
                                    <li>Sử dụng <strong>duy nhất 01 số điện thoại</strong> để đăng ký. Đây là mã số để hệ thống tích lũy <strong>Sao vàng</strong> và xếp loại sau này.</li>
                                    <li>Khi đi điểm danh, vui lòng <strong>bật 4G/5G và Vị trí (GPS)</strong> để hệ thống xác nhận tọa độ chính xác nhất.</li>
                                </ul>
                            </div>
                        </article>

                        <p class="subtitle is-6 has-text-grey mt-4">
                            Vui lòng điền chính xác thông tin để phục vụ công tác quản lý và điểm danh.
                        </p>
                    </div>

                    <form id="registerForm">
                        <div class="field">
                            <label class="label">Họ và tên <span class="has-text-danger">*</span></label>
                            <div class="control has-icons-left">
                                <input class="input" type="text" id="fullName" placeholder="VD: NGUYỄN VĂN A" required oninput="this.value = this.value.toUpperCase()" style="text-transform: uppercase;">
                                <span class="icon is-small is-left">
                                    <i class="fas fa-user"></i>
                                </span>
                            </div>
                            <p class="help is-danger is-hidden" id="errName">Vui lòng nhập họ tên đầy đủ (có dấu).</p>
                        </div>

                        <div class="columns">
                            <div class="column is-6">
                                <div class="field">
                                    <label class="label">Năm sinh <span class="has-text-danger">*</span></label>
                                    <div class="control has-icons-left">
                                        <input class="input" type="number" id="birthYear" placeholder="VD: 2005" required>
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-birthday-cake"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="column is-6">
                                <div class="field">
                                    <label class="label">Số điện thoại <span class="has-text-danger">*</span></label>
                                    <div class="control has-icons-left">
                                        <input class="input" type="tel" id="phone" placeholder="09xxxxxxx" required>
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-phone"></i>
                                        </span>
                                    </div>
                                    <p class="help is-danger is-hidden" id="errPhone">Số điện thoại không hợp lệ hoặc đã được đăng ký.</p>
                                </div>
                            </div>
                        </div>

                        <div class="field">
                            <label class="label">Trường học hiện tại</label>
                            <div class="control has-icons-left">
                                <div class="select is-fullwidth">
                                    <select id="school">
                                        <option value="">-- Đang tải dữ liệu... --</option>
                                    </select>
                                </div>
                                <span class="icon is-small is-left">
                                    <i class="fas fa-school"></i>
                                </span>
                            </div>
                            <input class="input mt-2 is-hidden" type="text" id="schoolManual" placeholder="Nhập tên trường của bạn...">
                            <p class="help is-info">
                                <i class="fas fa-info-circle mr-1"></i>
                                <i>Chọn "Khác" nếu không tìm thấy trường của bạn.</i>
                            </p>
                        </div>

                        <div class="field">
                            <label class="label">Lớp hiện tại</label>
                            <div class="control has-icons-left" id="classSelectControl">
                                <div class="select is-fullwidth">
                                    <select id="className">
                                        <option value="">-- Đang tải dữ liệu... --</option>
                                    </select>
                                </div>
                                <span class="icon is-small is-left">
                                    <i class="fas fa-chalkboard"></i>
                                </span>
                            </div>
                            <input class="input mt-2 is-hidden" type="text" id="classManual" placeholder="Nhập tên lớp của bạn...">
                            <p class="help is-info">
                                <i class="fas fa-info-circle mr-1"></i>
                                <i>Ví dụ: 10A1, 12D2...</i>
                            </p>
                        </div>



                        <div class="field mt-5">
                            <div class="control">
                                <button type="submit" class="button is-primary is-fullwidth is-rounded is-medium" id="btnSubmit">
                                    <span class="icon"><i class="fas fa-paper-plane"></i></span>
                                    <span>Gửi đăng ký</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Success Message Container -->
            <div id="successMessage" class="modal">
                <div class="modal-background"></div>
                <div class="modal-content">
                    <div class="box has-text-centered p-5">
                        <span class="icon is-large has-text-success mb-2">
                            <i class="fas fa-check-circle fa-4x"></i>
                        </span>
                        <h3 class="title is-4 mt-3">Đăng ký thành công!</h3>
                        <p class="mb-4">Thông tin của bạn đã được ghi nhận vào hệ thống.</p>
                        <a href="index.html" class="button is-primary is-rounded">Về trang chủ</a>
                    </div>
                </div>
            </div>

        </div>
    </section>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="js/config.js"></script>

    <script>
        const form = document.getElementById('registerForm');
        const btnSubmit = document.getElementById('btnSubmit');
        const successModal = document.getElementById('successMessage');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Basic Validation
            const fullName = document.getElementById('fullName').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const birthYear = document.getElementById('birthYear').value.trim();
            const schoolEl = document.getElementById('school');
            const classEl = document.getElementById('className');
            const schoolManual = document.getElementById('schoolManual');
            const classManual = document.getElementById('classManual');
            
            // Logic lấy dữ liệu
            let school = "";
            if (schoolEl.value === 'OTHER') {
                school = schoolManual.value.trim();
            } else if (schoolEl.value) {
                school = schoolEl.options[schoolEl.selectedIndex].text;
            }

            let className = "";
            // Nếu Trường là Khác HOẶC Lớp là Khác -> Lấy từ Manual Input
            if (schoolEl.value === 'OTHER' || classEl.value === 'OTHER') {
                className = classManual.value.trim();
            } else if (classEl.value) {
                className = classEl.options[classEl.selectedIndex].text;
            }

            if (fullName.length < 2) {
                document.getElementById('errName').classList.remove('is-hidden');
                return;
            } else {
                document.getElementById('errName').classList.add('is-hidden');
            }

            if (!/^\d{9,11}$/.test(phone)) {
                document.getElementById('errPhone').textContent = "Số điện thoại phải từ 9-11 chữ số.";
                document.getElementById('errPhone').classList.remove('is-hidden');
                return;
            } else {
                document.getElementById('errPhone').classList.add('is-hidden');
            }

            // Lock Button
            btnSubmit.classList.add('is-loading');
            btnSubmit.disabled = true;

            try {
                // Check duplicate phone
                const snapshot = await db.ref('sinhhoatdoan/members').orderByChild('phone').equalTo(phone).once('value');
                
                if (snapshot.exists()) {
                    throw new Error("Số điện thoại này đã được đăng ký trước đó!");
                }

                // Save Member
                const memberData = {
                    fullName,
                    phone,
                    birthYear,
                    school,
                    className,
                    registeredAt: firebase.database.ServerValue.TIMESTAMP,
                    status: 'active', // Trạng thái mặc định là active
                    stars: 0 // Số sao vàng ban đầu
                };

                const newRef = db.ref('sinhhoatdoan/members').push();
                await newRef.set(memberData);

                // Show Success
                successModal.classList.add('is-active');

            } catch (error) {
                console.error(error);
                if (error.message.includes("đã được đăng ký")) {
                    document.getElementById('errPhone').textContent = error.message;
                    document.getElementById('errPhone').classList.remove('is-hidden');
                } else {
                    alert('Đã có lỗi xảy ra: ' + error.message);
                }
                btnSubmit.classList.remove('is-loading');
                btnSubmit.disabled = false;
            }
        });

        // Load Metadata for Selects
        function loadRegisterMetadata() {
            db.ref('sinhhoatdoan/metadata/schools').once('value', snap => {
                const data = snap.val() || {};
                fillSelect('school', data, '-- Chọn trường --');
            });
        }

        function fillSelect(id, dataObj, defaultText) {
            const sel = document.getElementById(id);
            if (!sel) return;
            sel.innerHTML = `<option value="">${defaultText}</option>`;
            
            // Add OTHER option
            const otherOpt = document.createElement('option');
            otherOpt.value = "OTHER";
            otherOpt.textContent = "✎ Khác (Tự nhập)";
            otherOpt.style.fontWeight = "bold";
            otherOpt.style.color = "#00d1b2";
            sel.appendChild(otherOpt);

            if (!dataObj) return;
            
            // Convert to array of {key, val} and sort alphabetically by val
            const arr = Object.entries(dataObj).map(([key, val]) => ({key, val}))
                              .sort((a,b) => a.val.localeCompare(b.val));
            
            // Insert before OTHER? Or after? Usually OTHER is last.
            // Let's remove OTHER first if we want strict order, but appending after default is fine.
            // Actually, let's put OTHER at the end.
            sel.removeChild(otherOpt);
            
            arr.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.key;
                opt.textContent = item.val;
                sel.appendChild(opt);
            });
            
            // Append Other again at bottom
            sel.appendChild(otherOpt);
        }
        
        // Handle School Change
        document.getElementById('school').addEventListener('change', (e) => {
            const schoolId = e.target.value;
            const classSelect = document.getElementById('className');
            const schoolManual = document.getElementById('schoolManual');
            const classManual = document.getElementById('classManual');
            const classControl = document.getElementById('classSelectControl');

            // Reset UI
            schoolManual.classList.add('is-hidden');
            classManual.classList.add('is-hidden');
            classControl.classList.remove('is-hidden');
            classSelect.innerHTML = '<option value="">-- Đang tải... --</option>';

            if (!schoolId) {
                classSelect.innerHTML = '<option value="">-- Chọn lớp --</option>';
                return;
            }

            if (schoolId === 'OTHER') {
                // Show School Manual Input
                schoolManual.classList.remove('is-hidden');
                // Hide Class Select, Show Class Manual Input immediately (because no classes to load)
                classControl.classList.add('is-hidden');
                classManual.classList.remove('is-hidden');
                return;
            }

            // Normal School Selected
            db.ref(`sinhhoatdoan/metadata/classes/${schoolId}`).once('value', snap => {
                const data = snap.val() || {};
                fillSelect('className', data, '-- Chọn lớp --');
                if (!data || Object.keys(data).length === 0) {
                     // Nếu trường chưa có lớp nào -> Vẫn hiện select nhưng chỉ có Khác?
                     // Hàm fillSelect đã tự thêm Khác rồi.
                }
            });
        });

        // Handle Class Change (for OTHER case)
        document.getElementById('className').addEventListener('change', (e) => {
            const val = e.target.value;
            const classManual = document.getElementById('classManual');
            if (val === 'OTHER') {
                classManual.classList.remove('is-hidden');
            } else {
                classManual.classList.add('is-hidden');
            }
        });
        
        loadRegisterMetadata();
    </script>
</body>
</html>
