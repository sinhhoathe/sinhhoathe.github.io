<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - Qu·∫£n l√Ω Kh√°ch h√†ng</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <style>
        body { background: #1a1a1a; min-height: 100vh; }
        .navbar { background: #000; }
        .navbar-item, .navbar-link { color: #00d1b2 !important; font-weight: bold; }
        .card { background: #2c2c2c; color: white; border: 1px solid #444; }
        .title { color: white !important; }
        .label { color: #aaa !important; }
        .input, .select select { background: #333; color: white; border-color: #555; }
        .table { background: #2c2c2c; color: white; }
        .table th { color: #00d1b2; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <div class="navbar-item">üëë BOSS ADMIN</div>
        </div>
        <div class="navbar-end">
            <div class="navbar-item">
                <button class="button is-danger is-small" id="logoutBtn">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
    </nav>

    <section class="section">
        <div class="container">
            <div class="columns">
                <!-- Form t·∫°o t√†i kho·∫£n -->
                <div class="column is-4">
                    <div class="card">
                        <header class="card-header">
                            <p class="card-header-title">‚ûï C·∫•p t√†i kho·∫£n m·ªõi</p>
                        </header>
                        <div class="card-content">
                            <form id="createAccountForm">
                                <div class="field">
                                    <label class="label">T√™n ƒëƒÉng nh·∫≠p (Username)</label>
                                    <div class="control">
                                        <input class="input" type="text" id="newUsername" required placeholder="VD: khachhang01">
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label">M·∫≠t kh·∫©u</label>
                                    <div class="control">
                                        <input class="input" type="text" id="newPassword" required placeholder="M·∫≠t kh·∫©u">
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label">G√≥i ƒëƒÉng k√Ω</label>
                                    <div class="control">
                                        <div class="select is-fullwidth">
                                            <select id="packageType">
                                                <option value="1">1 Ng√†y (20k)</option>
                                                <option value="7">1 Tu·∫ßn (120k)</option>
                                                <option value="30">1 Th√°ng (360k)</option>
                                                <option value="365">1 NƒÉm (3.960k)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label">Ghi ch√∫ (T√™n kh√°ch/SƒêT)</label>
                                    <div class="control">
                                        <input class="input" type="text" id="note" placeholder="Nguyen Van A - 0912...">
                                    </div>
                                </div>
                                <div class="field">
                                    <button type="submit" class="button is-primary is-fullwidth">
                                        üí∞ X√°c nh·∫≠n c·∫•p quy·ªÅn
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Danh s√°ch kh√°ch h√†ng -->
                <div class="column is-8">
                    <div class="card">
                        <header class="card-header">
                            <p class="card-header-title">üìã Danh s√°ch kh√°ch h√†ng</p>
                        </header>
                        <div class="card-content">
                            <div class="table-container">
                                <table class="table is-fullwidth is-hoverable">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Pass</th>
                                            <th>H·∫øt h·∫°n</th>
                                            <th>Ghi ch√∫</th>
                                            <th>Tr·∫°ng th√°i</th>
                                            <th>H√†nh ƒë·ªông</th>
                                        </tr>
                                    </thead>
                                    <tbody id="userList">
                                        <tr><td colspan="6" class="has-text-centered">ƒêang t·∫£i...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="firebase.config.js"></script>
    
    <script>
        // B·∫£o m·∫≠t truy c·∫≠p trang n√†y
        const SUPER_ADMIN_PASS = "tranhuyhoang"; // Pass ri√™ng c·ªßa b·∫°n, c√≥ th·ªÉ ƒë·ªïi
        
        if (sessionStorage.getItem('super_admin') !== 'true') {
            const pass = prompt('Nh·∫≠p m·∫≠t kh·∫©u Super Admin:');
            if (pass !== SUPER_ADMIN_PASS) {
                alert('Sai m·∫≠t kh·∫©u!');
                window.location.href = 'index.html';
            } else {
                sessionStorage.setItem('super_admin', 'true');
            }
        }

        document.getElementById('logoutBtn').addEventListener('click', () => {
            sessionStorage.removeItem('super_admin');
            window.location.reload();
        });

        // Logic qu·∫£n l√Ω
        const form = document.getElementById('createAccountForm');
        const userList = document.getElementById('userList');

        // Load users
        firebase.database().ref('users').on('value', (snapshot) => {
            const users = snapshot.val();
            userList.innerHTML = '';
            
            if (!users) {
                userList.innerHTML = '<tr><td colspan="6" class="has-text-centered">Ch∆∞a c√≥ kh√°ch h√†ng n√†o</td></tr>';
                return;
            }

            Object.keys(users).forEach(username => {
                const user = users[username];
                const expiryDate = new Date(user.expiryDate);
                const isExpired = Date.now() > user.expiryDate;
                const statusHtml = isExpired 
                    ? '<span class="tag is-danger">H·∫øt h·∫°n</span>' 
                    : '<span class="tag is-success">Ho·∫°t ƒë·ªông</span>';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${username}</strong></td>
                    <td>${user.password}</td>
                    <td>${expiryDate.toLocaleDateString('vi-VN')}</td>
                    <td>${user.note || '-'}</td>
                    <td>${statusHtml}</td>
                    <td>
                        <button class="button is-small is-danger" onclick="deleteUser('${username}')">
                            üóëÔ∏è X√≥a & D·ªçn d·∫πp
                        </button>
                    </td>
                `;
                userList.appendChild(tr);
            });
        });

        // Create User
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('newUsername').value.trim().toLowerCase(); // Username ch·ªØ th∆∞·ªùng kh√¥ng d·∫•u
            const password = document.getElementById('newPassword').value.trim();
            const days = parseInt(document.getElementById('packageType').value);
            const note = document.getElementById('note').value;

            if (/[^a-z0-9]/.test(username)) {
                alert('Username ch·ªâ ƒë∆∞·ª£c ch·ª©a ch·ªØ th∆∞·ªùng v√† s·ªë, kh√¥ng d·∫•u, kh√¥ng kho·∫£ng c√°ch!');
                return;
            }

            // T√≠nh ng√†y h·∫øt h·∫°n
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + days);

            const userData = {
                password: password,
                expiryDate: expiryDate.getTime(),
                note: note,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            };

            try {
                // Ki·ªÉm tra user t·ªìn t·∫°i ch∆∞a
                const snapshot = await firebase.database().ref(`users/${username}`).once('value');
                if (snapshot.exists() && !confirm('User n√†y ƒë√£ t·ªìn t·∫°i. B·∫°n c√≥ mu·ªën ghi ƒë√® (gia h·∫°n) kh√¥ng?')) {
                    return;
                }

                await firebase.database().ref(`users/${username}`).set(userData);
                alert(`‚úÖ ƒê√£ c·∫•p quy·ªÅn cho [${username}] th√†nh c√¥ng!\nH·∫øt h·∫°n: ${expiryDate.toLocaleDateString()}`);
                form.reset();
            } catch (error) {
                alert('L·ªói: ' + error.message);
            }
        });

        // Delete User and CLEANUP Data
        window.deleteUser = async function(username) {
            if (!confirm(`‚ö†Ô∏è C·∫¢NH B√ÅO CAO ƒê·ªò!\n\nB·∫°n s·∫Øp x√≥a kh√°ch h√†ng [${username}].\n\nH√†nh ƒë·ªông n√†y s·∫Ω:\n1. X√≥a t√†i kho·∫£n ƒëƒÉng nh·∫≠p.\n2. X√ìA TO√ÄN B·ªò d·ªØ li·ªáu h·ªôi ngh·ªã v√† ƒëi·ªÉm danh c·ªßa h·ªç ƒë·ªÉ gi·∫£i ph√≥ng dung l∆∞·ª£ng.\n\nB·∫°n ch·∫Øc ch·∫Øn ch·ª©?`)) {
                return;
            }

            // Y√™u c·∫ßu nh·∫≠p l·∫°i m·∫≠t kh·∫©u ƒë·ªÉ x√°c nh·∫≠n
            const confirmPass = prompt("üîí ƒê·ªÉ th·ª±c hi·ªán x√≥a vƒ©nh vi·ªÖn, vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u Super Admin:");
            
            if (confirmPass !== SUPER_ADMIN_PASS) {
                alert("‚õî M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng! Thao t√°c ƒë√£ b·ªã h·ªßy ƒë·ªÉ b·∫£o v·ªá d·ªØ li·ªáu.");
                return;
            }

            try {
                // Delete both paths concurrently for speed, but catch errors individually if needed
                const updates = {};
                updates[`users/${username}`] = null;
                updates[`tenants/${username}`] = null;
                
                await firebase.database().ref().update(updates);

                alert('‚úÖ ƒê√£ x√≥a kh√°ch h√†ng v√† d·ªçn d·∫πp s·∫°ch d·ªØ li·ªáu h·ªôi ngh·ªã/ƒëi·ªÉm danh!');
            } catch (error) {
                console.error(error);
                alert('L·ªói khi x√≥a: ' + error.message);
            }
        };
    </script>
</body>
</html>
