name: Obfuscate and Deploy
on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install Obfuscator
        run: npm install -g javascript-obfuscator

      - name: Prepare dist folder
        run: |
          mkdir -p dist
          # Tạo sẵn cấu trúc thư mục giống hệt bản gốc bên trong dist
          mkdir -p "dist/Diemdanh" "dist/Kyluat" "dist/Sinhhoatdoan" "dist/Sinhhoathe"

      - name: Obfuscate ALL JS files
        # Lệnh này sẽ quét CẢ THƯ MỤC GỐC VÀ CÁC THƯ MỤC CON để mã hóa từng file .js một
        run: |
          javascript-obfuscator ./ --output ./dist --compact true --self-defending true --string-array true --string-array-encoding 'base64' --string-array-threshold 1

      - name: Copy static files (HTML, CSS, Images, CNAME)
        # Bước này cực kỳ quan trọng: chỉ copy file giao diện, không copy đè file .js gốc vào dist
        run: |
          cp index.html ./dist/ || true
          cp CNAME ./dist/ || true
          # Sử dụng rsync để copy toàn bộ ảnh, html, css nhưng loại trừ các file .js gốc
          rsync -av --exclude='*.js' Diemdanh/ dist/Diemdanh/ || true
          rsync -av --exclude='*.js' Kyluat/ dist/Kyluat/ || true
          rsync -av --exclude='*.js' Sinhhoatdoan/ dist/Sinhhoatdoan/ || true
          rsync -av --exclude='*.js' Sinhhoathe/ dist/Sinhhoathe/ || true

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: gh-pages
