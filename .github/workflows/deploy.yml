name: Obfuscate and Deploy
on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install Tools
        # Cài đặt cả công cụ làm rối JS và nén HTML
        run: |
          npm install -g javascript-obfuscator
          npm install -g html-minifier

      - name: Prepare dist folder
        run: |
          mkdir -p dist
          mkdir -p "dist/Diemdanh" "dist/Kyluat" "dist/Sinhhoatdoan" "dist/Sinhhoathe"

      - name: Obfuscate ALL JS files
        # Mã hóa toàn bộ file .js vào thư mục dist
        run: |
          javascript-obfuscator ./ --output ./dist --compact true --self-defending true --string-array true --string-array-encoding 'base64' --string-array-threshold 1

      - name: Minify HTML
        run: |
          npm install -g html-minifier
          # Nén file index.html gốc
          html-minifier --collapse-whitespace --remove-comments --minify-js true --minify-css true index.html -o dist/index.html || true
          
          # Dùng vòng lặp để nén TẤT CẢ file html trong các thư mục con
          find . -name "*.html" -not -path "./dist/*" -not -path "./node_modules/*" | while read file; do
            mkdir -p "dist/$(dirname "$file")"
            html-minifier --collapse-whitespace --remove-comments --minify-js true --minify-css true "$file" -o "dist/$file"
          done
        # Copy các tài nguyên còn lại, loại trừ JS (đã làm rối) và HTML (đã nén)
        run: |
          cp CNAME ./dist/ || true
          rsync -av --exclude='*.js' --exclude='*.html' Diemdanh/ dist/Diemdanh/ || true
          rsync -av --exclude='*.js' --exclude='*.html' Kyluat/ dist/Kyluat/ || true
          rsync -av --exclude='*.js' --exclude='*.html' Sinhhoatdoan/ dist/Sinhhoatdoan/ || true
          rsync -av --exclude='*.js' --exclude='*.html' Sinhhoathe/ dist/Sinhhoathe/ || true

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: gh-pages
